{% extends "base.html" %}
{% load static %}
{% load custom_tags %}
{% block title %}Update Job{% endblock %}
{% block head %}
        <link rel="stylesheet" type="text/css" href="{% static 'css/job_list.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'css/index.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'css/newindexlist.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'css/add_job_style.css' %}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <!-- {% comment %} <script src="{% static 'js/index.js' %}"></script> {% endcomment %} -->
        <script src="{% static 'js/createJob.js' %}"></script>
        <script src="{% static 'js/update.js' %}"></script>
        <script src="{% static 'js/downloadfile.js' %}"></script>
        <script src="{% static 'js/chat.js' %}"></script>
        <script src="{% static 'js/jquery.formset.js' %}"></script>
{% endblock %}
{% block content %}
    {% include 'common/navbar.html' %} 
    <div class="container-fluid mt-2">
        <form action="{% url 'job:appupdatejob' pk=form.instance.id %}"  method='POST' id='updatejobform' enctype="multipart/form-data" novalidate >
          {% csrf_token %}
          <div class="header">
            <h5> <a class="navbar-brand" href="{% url 'job:home' %}">Virtual Request</a><span>/{{form.instance.id}}</span></h5>
            <div class="btn_wrapper">
              <button type="submit" class='btn btn-sm btn-primary' id='updatebtn'>Save</button>
              <a href="{% url 'job:jobdetail' pk=form.instance.id %}" class='btn btn-sm btn-outline-secondary'>Discard</a>
              <button class='btn btn-sm btn-outline-secondary' id='customeremailbtn'>Send art to customer</button>
            </div>
          </div>
          <div class="breadcrumbs d-flex justify-content-around">
            <div class='breadcrumbs_item'> <span>New</span>
              <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item '> <span>In progress</span>
              <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item'> <span>On Hold</span>
              <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item'> <span>Queries</span>
                <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item'> <span>Corrections</span>
                <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item'> <span>Rush Corrections</span>
                <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item'> <span >Completed</span>
                <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item'> <span>Cancelled</span>
                <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item'> <span>Queries Resolved</span>
                <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item'> <span>Customer Approved</span>
                <div class="arrow">
              </div>
            </div>
            <div class='breadcrumbs_item'> <span>Final Approved</span>
            </div>
          </div>
          <div class='form_wrapper' >
              <div class="row">
                  <div class='col-6 job_form'>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label star">Virtual Request #</label>
                      <div class="col-sm-7" id="virtual_req">
                       <!-- <label>{{form.job_id.value}}</label> -->
                       {{form.instance.id}}
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label star">Quote # <span class='text-danger'>*</span></label>
                      <div class="col-sm-7">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                        {{form.quote_no}}
                        {% if form.quote_no.errors %}
                            <div class="error_msg text-danger">
                                {{ form.quote_no.errors.0 }}
                            </div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">REP S Email</label>
                      <div class="col-sm-7">
                        <input type="text" name="user_email" value="{{job_data.email}}" disabled class="form-control form-control-sm" id="id_user_email">
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Logo Name</label>
                      <div class="col-sm-7">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                        {{form.logo_name}}
                          {% if form.logo_name.errors %}
                              <div class="error_msg text-danger">
                                  {{ form.logo_name.errors.0 }}
                              </div>
                          {% endif %}
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Logo (Use Same Art For All)</label>
                      <div class="col-sm-7">
                        {% comment %} <input class="form-check-input" type="checkbox" value="" id="flexCheckChecked" checked> {% endcomment %}
                        {{form.logo_same_for_all}}
                          {% if form.logo_same_for_all.errors %}
                              <div class="error_msg text-danger">
                                  {{ form.logo_same_for_all.errors.0 }}
                              </div>
                          {% endif %}
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Send Art to Customer</label>
                      <div class="col-sm-7">
                        {% comment %} <input class="form-check-input" type="checkbox" value="" id="flexCheckChecked" checked> {% endcomment %}
                        {{form.send_art_to_customer}}
                          {% if form.send_art_to_customer.errors %}
                              <div class="error_msg text-danger">
                                  {{ form.send_art_to_customer.errors.0 }}
                              </div>
                          {% endif %}
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center remove_mail" id="customer_email">
                      <label for="fa_customer_email" class="col-md-3 col-form-label">Customer Email <span class='text-danger'>*</span></label>
                      <div class="col-sm-7">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                          {{form.customer_email}}
                          {% if form.customer_email.errors %}
                              <div class="error_msg text-danger">
                                  {{ form.customer_email.errors.0 }}
                              </div>
                          {% endif %}
                      </div>
                    </div>
                    <!-- <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label star">Submitted Date</label>
                      <div class="col-sm-7" id="virtual_req">
                        {{job_data.submitted_date}}
                      </div>
                    </div> -->
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Job Type <span class='text-danger'>*</span></label>
                      <div class="col-sm-7">
                        {% comment %} <select class="form-select form-select-sm py-0" aria-label=".form-select-sm example">
                          <option selected>Open this select menu</option>
                          <option value="1">One</option>
                          <option value="2">Two</option>
                          <option value="3">Three</option>
                        </select> {% endcomment %}
                          {{form.proof_request_type}}
                          {% if form.proof_request_type.errors %}
                              <div class="error_msg text-danger">
                                  {{ form.proof_request_type.errors.0 }}
                              </div>
                          {% endif %}
                      </div>
                    </div>
                    
                  </div>
                  <div class='col-6'>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label star">Submitted Date</label>
                      <div class="col-sm-7" id="virtual_req">
                        {{job_data.submitted_date}}
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Customer # <span class='text-danger'>*</span></label>
                      <div class="col-sm-7">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                        {{form.customer_no}}
                          {% if form.customer_no.errors %}
                              <div class="error_msg text-danger">
                                  {{ form.customer_no.errors.0 }}
                              </div>
                          {% endif %}
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Segment #</label>
                      <div class="col-sm-7">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                        {{form.segment_no}}
                          {% if form.segment_no.errors %}
                              <div class="error_msg text-danger">
                                  {{ form.segment_no.errors.0 }}
                              </div>
                          {% endif %}
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Customer Name <span class='text-danger'>*</span></label>
                      <div class="col-sm-7">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                        {{form.customer_name}}
                          {% if form.customer_name.errors %}
                              <div class="error_msg text-danger">
                                  {{ form.customer_name.errors.0 }}
                              </div>
                          {% endif %}
                      </div>
                    </div>
                    <!-- <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Segment #</label>
                      <div class="col-sm-7">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                        {{form.segment_no}}
                          {% if form.segment_no.errors %}
                              <div class="error_msg text-danger">
                                  {{ form.segment_no.errors.0 }}
                              </div>
                          {% endif %}
                      </div>
                    </div> -->
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Campaign</label>
                      <div class="col-sm-7 campaign_wrapper job_form">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                        {{form.campaign}}
                        {% if form.campaign.errors %}
                            <div class="error_msg text-danger">
                                {{ form.campaign.errors.0 }}
                            </div>
                        {% endif %}
                        <button class="btn btn-primary campaign_btn" type="button" data-bs-toggle="modal" data-bs-target="#staticBackdrop" >
                          <span><i class='fa fa-pencil'></i></span>
                        </button>
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Ref #</label>
                      <div class="col-sm-7">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                        <input type="text" name="rep_no" value="{{job_data.rep_no}}" class="form-control form-control-sm" disabled="" id="id_rep_no">
                        
                      </div>
                    </div>
                    <div class="mb-12 mb-3 row d-flex align-items-center">
                      <label for="inputPassword" class="col-md-3 col-form-label">Status <span class='text-danger'>*</span></label>
                      <div class="col-sm-7">
                        {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                        {{form.status}}
                        {% if form.status.errors %}
                            <div class="error_msg text-danger">
                                {{ form.status.errors.0 }}
                            </div>
                        {% endif %}
                      </div>
                    </div>
                    <!-- <div class="download_btn">
                      <button class="btn btn-primary btn-sm" id="download_btn">Download Completed Files</button>
                    </div> -->
                  </div>
              </div>
              <div>
                <div class='form_wrapper' >
                  {{ jobitem_form.management_form }}
                  {% for form in jobitem_form %}
                  {% csrf_token  %}
                    {{form.id}}
                  {% comment %} {% with files = job|get_files:form.id.value %}
                      {{files}}
                    {% endwith %} {% endcomment %}
                    <!-- {% with files=job|get_files:form.id.value %} -->
                  <div class="row" style="margin-top: -14px;" >
                      <div class='col-6 job_form'>
                        <div class="mb-12 mb-3 row d-flex align-items-start">
                          <label for="inputPassword" class="col-md-3 col-form-label start">Item <span class='text-danger'>*</span></label>
                          <div class="col-sm-7" >
                            {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                            {{form.item}}
                            {% if form.item.errors %}
                                <div class="error_msg text-danger">
                                  {{ form.item.errors.0 }}
                                </div>
                            {% endif %}
                          </div>
                        </div>
                        <div class="mb-12 mb-3 row d-flex align-items-start">
                          <label for="inputPassword" class="col-md-3 col-form-label">Product Color</label>
                          <div class="col-sm-7">
                            {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                            {{form.product_color}}
                                  <div class="error_msg text-danger">
                                  </div>
                          </div>
                        </div>
                        <div class="mb-12 mb-3 row d-flex align-items-start">
                          <label for="inputPassword" class="col-md-3 col-form-label">Imprint Color</label>
                          <div class="col-sm-7">
                            {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                            {{form.imprint_color}}
                              {% if form.logo_name.errors %}
                                  <div class="error_msg text-danger">
                                      {{ form.logo_name.errors.0 }}
                                  </div>
                              {% endif %}
                          </div>
                        </div>
                        <div class="mb-12 mb-3 row d-flex align-items-start">
                          <label for="inputPassword" class="col-md-3 col-form-label">Submitted Files <span class='text-danger'></span></label>
                          <div class="col-sm-7">
                            {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                            
                            {{ form.submitted_files }}
                            {% if form.submitted_files.errors %}
                                  <div class="error_msg text-danger">
                                    {{ form.submitted_files.errors.0 }}
                                  </div>
                              {% endif %}
                              <div class='file-wrapper d-flex justify-content-between align-items-start' style="margin-left: 14px;">
                                    {% for i in files.submitted_files %}
                                    <div class="alert alert-secondary alert-dismissible fade show py-1 px-2 mb-1 job_files" id ="file-sub" role="alert">
                                      <label data-bs-toggle="tooltip" data-bs-placement="top" title="{{i.file_name}}" data-bs-html="true" data-url="{% url 'job:downloadfile' file_type=i.file_type file_id=i.sub_files__id %}" style="font-size: 13px;">{{i.file_name|truncatechars:19}}</label>
                                      <span class="alert-close-btn" key="true" data-source='{{i.file_name}}' onclick = "removeFile(this)" data-key={{i.sub_files__id}} data-id="id_job-{{forloop.parentloop.counter0}}-submitted_files" data-type='{{i.file_type}}'><i class="fa fa-trash text-danger"></i></span>
                                    </div>
                                  {% endfor %}
                              </div>
                          </div>

                        </div>
                      </div>
                        <div class='col-6'>
                          <div class="mb-12 mb-3 row d-flex align-items-start">
                            <label for="inputPassword" class="col-md-3 col-form-label">Imprint Location <span class='text-danger'></span></label>
                            <div class="col-sm-7">
                              {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                              {{form.imprint_location}}
                                {% if form.customer_no.errors %}
                                    <div class="error_msg text-danger">
                                        {{ form.customer_no.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                          </div>
                          <div class="mb-12 mb-3 row d-flex align-items-start">
                            <label for="inputPassword" class="col-md-3 col-form-label">Imprint Method</label>
                            <div class="col-sm-7">
                              {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                              {{form.imprint_method}}
                                {% if form.segment_no.errors %}
                                    <div class="error_msg text-danger">
                                        {{ form.segment_no.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                          </div>
                          <div class="mb-12 mb-3 row d-flex align-items-start">
                            <label for="inputPassword" class="col-md-3 col-form-label">Imprint Instructions <span class='text-danger'></span></label>
                            <div class="col-sm-7">
                              {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                              {{form.imprint_instructions}}
                                {% if form.customer_name.errors %}
                                    <div class="error_msg text-danger">
                                        {{ form.customer_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                          </div>
                          <div class="mb-12 mb-3 row d-flex align-items-start">
                            <label for="inputPassword" class="col-md-3 col-form-label">Completed Datetime<span class='text-danger'></span></label>
                            <div class="col-sm-7" style="font-size: 14px;">
                              {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                              {{form.completed_datetime.value}}
                                {% if form.customer_name.errors %}
                                    <div class="error_msg text-danger">
                                        {{ form.customer_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                          </div>
                          <div class="mb-12 mb-3 row d-flex align-items-start">
                            <label for="inputPassword" class="col-md-3 col-form-label">Completed Files <span class='text-danger'></span></label>
                            <div class="col-sm-7">
                              {% comment %} <input type="text" class="form-control form-control-sm" id="inputPassword"> {% endcomment %}
                              {{form.completed_files}} 
                              {% if form.completed_files.errors %}
                                    <div class="error_msg text-danger">
                                      {{ form.completed_files.errors.0 }}             
                                    </div>
                                {% endif %}
                                <div class='file-wrapper d-flex justify-content-between align-items-start'>
                                  {% for i in files.completed_files %}
                                    <div class="alert alert-secondary alert-dismissible fade show py-1 px-2 mb-1 job_files" id="filecom"role="alert">
                                      <label data-bs-toggle="tooltip" data-bs-placement="top" title="{{i.file_name}}" data-bs-html="true" data-url="{% url 'job:downloadfile' file_type=i.file_type file_id=i.com_files__id %}" style="font-size: 13px;">{{i.file_name|truncatechars:19}}</label>
                                      <span class="alert-close-btn" key="true" data-source='{{i.file_name}}' onclick = "removeFile(this)"   data-key={{i.com_files__id}} data-id="id_job-{{forloop.parentloop.counter0}}-completed_files" data-type='{{i.file_type}}'><i class="fa fa-trash text-danger"></i></span>
                                    </div>
                                  {% endfor %}
                                </div>
                            </div>
                          </div>
                          <div class="download_btn d-flex justify-content-start">
                            <button class="btn btn-primary btn-sm down-btns" id="download_btn">Download Completed Files</button>
                          </div>
                          </div>

                      </div>
                      {% endwith %}
                      {% endfor %} 
                  </div>

                <div class="mb-12 mt-6 row d-flex align-items-start">
                  <label class="col-form-label">Note</label>
                  <div class="col-12">
                      {{form.note}}
                    </div>
                </div>
        </div>
        <div class="btn_wrapper">
          <button type="submit" class='btn btn-sm btn-primary' id='updatebtn1'>Save</button>
          <button class='btn btn-sm btn-outline-secondary' id = 'discard_btn1'>Discard</button>
        </div>
      </form>
      <form id='chat_form'>
        {% csrf_token %}
        <div>
          <div class="mb-12 mt-6 row d-flex align-items-center">
            <label class="col-form-label">Send Message</label>
            <div class="col-12">
              <textarea name="send_message" cols="40" rows="3" class="form-control form-select-sm" placeholder="write something..." id="id_msg" ></textarea>
              <div class="download_btn d-flex align-items-center mt-2 chat_btn_wrapper">
                <button class='btn btn-primary btn-sm' id='send' disabled>Send</button>
                <label class='btn btn-outline-secondary btn-sm disabled_attachement' for='attachment' style='font-size:13px' id='attach' disabled>Attachment</label>
                <span id='file_name'></span>
                <input type='file' id='attachment' style='display:none' disabled>
              </div>
            </div>
          </div>
        </div>  
      </form>
      <div class="chat_wrapper mt-2">
        {% for msg in msgs %}
        <div class="msg_wrapper my-2">
          <div class="sender_header">Note by <span class='sender_name'>{{msg.user_id}}</span> - {{msg.log_datetime}}</div>
          <ul class="msg remove_bul">
            <li>{{msg.details}}</li>
            {% if msg.prev_status and msg.new_status %}
            <span> Status : 
              {{msg.prev_status}} 
              <span style='font-size:18px;'>&#8594;</span>
              {{msg.new_status}}
            </span>
            {% endif %}
            {% if msg.attachment %}
              <li><label data-chat-url="{% url 'job:downloadfile' file_type=msg.attachment.file_type file_id=msg.id %}">{{msg.filename}}</label></li>
            {% endif %}
          </ul>
        </div>
      {% endfor %}
      </div>
    </div>
    
    
    <!-- update campaign modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered  modal-sm">
          <div class="modal-content">
            <div class="modal-header py-2">
              <h1 class="modal-title fs-6" id="exampleModalLabel">Create Campaign</h1>
              <button type="button" class="btn-close btn-sm close_btn" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-2">
              <div class="mb-3">
                <label for="campaign_name" class="form-label">Campaign Name</label>
                <input type="text" class="form-control form-control-sm" id="campaign_name" data-id placeholder="Enter campaign name">
              </div>
            </div>
            <div class="modal-footer py-2">
              <button type="button" class="btn btn-secondary btn-sm close_btn" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary btn-sm" id="campaign_add_btn" disabled>Add</button>
            </div>
          </div>
      </div>
    </div>
    <!-- end campaign modal -->
    <script src="{% static 'js/jquery.formset.js' %}"></script>
    <!-- <script src="{% static 'js/createJob.js' %}"></script> -->
    <script type="text/javascript">
      $(".inline.{{ jobitem_form.prefix }}").formset({
          addText: `<a class='btn btn-primary btn-sm mt-2'>Add</a>`,
          deleteText: `<a class="delete-row btn btn-outline-danger btn-sm" href="javascript:void(0)"><i class="fa fa-trash"></i></a>`,
          copyRow:`<a class='copy-row mt-2' href="javascript:void(0)"><button class='btn btn-primary btn-sm' style="margin-top: 5px">Copy</button></i></a>`,
          prefix: '{{ jobitem_form.prefix }}',
      });
      let job_id = "{{form.instance.id}}"
      const removeFile = (e) =>{
        if($(e).attr('key')=='true'){
          let res = confirm("Are you sure you want to delete this file ")
          if(res==true){
            let file_id = $(e).attr('data-key')
            let file_type = $(e).attr('data-type')
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val();
            let formData = new FormData()
            formData.append('file_id',file_id);
            formData.append('file_type',file_type)
            formData.append('csrfmiddlewaretoken',csrfToken)
            let path = window.location.href;
            $('.page_loader').css('display','flex');
            $.ajax({
              url:path,
              type:'POST',
              data:formData,
              processData: false,
              contentType: false,
              success: function (data, textStatus, xhr) {
                $('.page_loader').css('display','none');
                deleteFile(e)
              }
            })
        }
        }else{
          deleteFile(e)
        }
        
      }
      
      // let submitted_file = {}
      // const handleFileOnChange = (e) => {
      //   // {% comment %} $(e).next().empty() {% endcomment %}
      //   let Files = Array.from(e.files);
      //   let filesLength = Files.length;
      //   let type = $(e).attr("data-id");
      //   let fileName = submitted_file[e.id] != undefined ? submitted_file[e.id].map(f=>f.name) : []
      //   submitted_file[e.id] = submitted_file[e.id] != undefined ? [... new Set(submitted_file[e.id].concat(Files.filter(f=> !fileName.includes(f.name))))] : Files;
      //   let newFileList = new DataTransfer();
      //   submitted_file[e.id].map(f=>newFileList.items.add(f))
      //   debugger;
      //   e.files = newFileList.files
      //   $.each(submitted_file[e.id],(id,elm) => {
      //         let alertBox = `<div class="alert alert-secondary alert-dismissible fade show py-1 px-2 mb-1" role="alert">
      //                             <p class='mb-0 alert-file-name'>${elm.name}</p> in these code newFiles when add and these file already exist thesn first time these same file add and second time is no add
      //                       {% comment %} <button type="button" class="btn-close ps-2"></button> {% endcomment %}
      //                       <span class="alert-close-btn" key="false" onclick = "removeFile(this)" data-source='${elm.name}' data-id="${e.id}"><i class="fa fa-trash text-danger"></i></span>
      //                   </div>`
      //         $(e).next().prepend(alertBox)
      //   })
      // };
    let submitted_files = {};

    const handleFileOnChange = (e) => {
      const Files = Array.from(e.files);
      const type = $(e).attr("data-id");

      const existingFiles = submitted_files[e.id] || [];
      const newFiles = Files.filter(f => !existingFiles.some(ef => ef.name === f.name));
      submitted_files[e.id] = [...existingFiles, ...newFiles];

      const newFileList = new DataTransfer();
      submitted_files[e.id].forEach(f => newFileList.items.add(f));

      e.files = newFileList.files;

      submitted_files[e.id].forEach(elm => {
        const alertExists = $(e).next().find(`[data-source="${elm.name}"]`).length > 0;
        if (!alertExists) {
          const alertBox = `
            <div class="alert alert-secondary alert-dismissible fade show py-1 px-2 mb-1" role="alert">
              <p class='mb-0 alert-file-name'>${elm.name}</p>
              <span class="alert-close-btn" key="false" onclick="removeFile(this)" data-source='${elm.name}' data-id="${e.id}">
                <i class="fa fa-trash text-danger"></i>
              </span>
            </div>`;
          $(e).next().prepend(alertBox);
        }
      });
    };



      var user = '{{user.role}}';
      const deleteFile = (e) =>{
        
        let fileName = $(e).attr('data-source');
        let parentId = $(e).attr('data-id')
        let fileList = $(`#${parentId}`)[0]
        let fileArray = Array.from(fileList.files);
        let finalList = fileArray.filter(f => f.name != fileName);
        let newFileList = new DataTransfer();
        finalList.map(f=>newFileList.items.add(f))
        fileList.files = newFileList.files
        $(e).parent().closest('div').remove();
        if ($(e).attr('data-key')==''){
          submitted_file[$(e).attr('data-id')] = submitted_file[$(e).attr('data-id')].filter(f=>f.name!=$(e).attr('data-source'));
        }
      }
      
    </script>
    
    <script>
      let job_id_id = "{{form.instance.id}}"
            document.getElementById('download_btn').addEventListener('click', function(e) {
              e.preventDefault();
              var id = job_id_id;
              var url = '/download_zip_file/' + id;
              var xhr = new XMLHttpRequest();
              xhr.open('GET', url, true);
              xhr.responseType = 'blob';
              xhr.onload = function() {
                if (xhr.status === 200) {

                  var blob = new Blob([xhr.response], { type: 'application/zip' });

                  var link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  quote_no_com_zip = "{{form.instance.quote_no}}"
                  link.download = quote_no_com_zip + ' - ' + 'Completed files.zip'
                  link.style.display = 'none';
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                }
                $('.page_loader').css('display','none');
              };
              xhr.onprogress = function(event) {
                if (event.lengthComputable) {
                  var percentage = Math.floor((event.loaded / event.total) * 100);
                }
              };
              xhr.onerror = function() {
              };
              xhr.send();
              $('.page_loader').css('display','flex');
            });
            let status = $('#id_status option:selected').text();
            $('.breadcrumbs_item').each(function() {
              var spanText = $(this).find('span').text();
    
              if (spanText === status) {
                $(this).addClass('highlight');
                $(this).find('.arrow').addClass('highlight-arrow');
              }
            });
            
    </script>
    <style>
      .highlight {
        background-color: #e9ecef;
        color:#0d6efd;
      }
      
      .highlight-arrow {
        background-color:#e9ecef;
      }
    </style>           
{% endblock %}